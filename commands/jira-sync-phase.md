# /jira-sync-phase

Run this command after `/gsd:discuss-phase [N]` to update the corresponding Jira Epic with the context and objectives discussed.

Safely skips phases that are already complete in GSD — no accidental overwrites.

## Usage

```
/jira-sync-phase 1
/jira-sync-phase 2
```

## What it does

1. Checks GSD STATE.md — if the phase is already complete, stops with a clear message
2. Reads the phase CONTEXT.md generated by GSD
3. Updates the Jira Epic with the detailed description
4. Verifies the Epic name matches the GSD branch format
5. Transitions the Epic to In Progress
6. Updates the manifest

## Instructions for Claude

<instructions>

### Step 1 — Read phase number from input

The user passed a number (e.g. `1`). Call it `PHASE_NUM`.

If not provided, ask: "Which phase do you want to sync? (e.g. /jira-sync-phase 1)"

### Step 2 — Read config and manifest

Read `gsd-jira-bridge.json` (local first, then global).
Read `.planning/jira-bridge/manifest.json`.

Find the entry in `phases` with `gsd_phase == PHASE_NUM`.
Extract `jira_epic_key`, `jira_epic_id`, `gsd_branch`, and `status`.

If the phase is not in the manifest, stop:
```
✗ Phase N not found in manifest. Did you run /jira-init?
```

### Step 3 — Check phase completion state

Read `.planning/STATE.md` to verify the current state of this phase.

**If the phase is already `done` in GSD STATE.md OR manifest status is `done`:**
```
⏭ Phase N is already complete in GSD.
  Epic [EPIC_KEY] should already be set to Done in Jira.
  No update needed.

  If you want to add notes to the Epic anyway, edit it directly in Jira:
  [base_url]/browse/[EPIC_KEY]
```
Stop — do not modify the Epic.

**If the phase is `todo` in GSD (discuss-phase not run yet):**
```
⚠ Phase N has not been discussed in GSD yet.
  Run /gsd:discuss-phase N first, then re-run /jira-sync-phase N.
```
Stop.

Only proceed if the phase is `in_progress` or if STATE.md shows discuss-phase has run.

### Step 4 — Read the phase CONTEXT.md

Look for `.planning/phases/[N]-*/CONTEXT.md`.
Extract: main objectives, expected deliverables, success criteria, constraints.

If not found, fall back to the phase section in `ROADMAP.md`.

### Step 5 — Check the active GSD branch

Run:
```bash
git branch --show-current
```

Compare the current branch with `gsd_branch` from the manifest.

- If they match → ok, note the branch in the final summary
- If they don't match → show a warning (do not block):
  ```
  ⚠ Active branch: [current_branch]
     Expected branch: gsd/phase-{N}-{slug}
     GSD may not have created the branch yet (normal before execute-phase)
  ```

### Step 6 — Update the Epic in Jira

Use the Jira MCP to update the Epic with `jira_epic_key`:
- `description`: formatted content from CONTEXT.md
- Add label `"gsd-in-discussion"` if not already present

### Step 7 — Transition Epic to "In Progress"

Use the Jira MCP to get available transitions and apply "In Progress".

### Step 8 — Update the manifest

```json
{
  "status": "in_progress",
  "context_synced_at": "<ISO timestamp>"
}
```

### Step 9 — Output summary

```
✓ Phase N synced with Jira

  Epic    → [EPIC_KEY]: gsd/phase-{N}-{slug}
  Branch  → gsd/phase-{N}-{slug} (will be created by GSD at /gsd:execute-phase)
  Status  → In Progress
  Context → synced from CONTEXT.md

  Next step: /gsd:plan-phase N → then /jira-sync-tasks N
```

</instructions>
